<style>
    .toolbar-button {
        border: none;
        color: #eee;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        margin: auto 0 auto 12pt;
        padding: 3.5pt;
    }

    .red-ui-tab-save-flow-indicator.ui-draggable > a.red-ui-tab-label {
        background-image: linear-gradient(#99ee99, #aaffaa);
    }
    .red-ui-tab-save-flow-indicator.ui-draggable > a.red-ui-tab-label:hover {
        background-image: linear-gradient(#81d781, #93e893);
    }

    .toolbar-button.toolbar-button-disabled {
        color: #999 !important;
        background-color: #444 !important;
        cursor: default !important;
    }

    .flow-manager-save-button {
        background-color: #00701b !important;
    }

    .flow-manager-filter-flows-button {
        background-color: #176670 !important;;
    }
</style>

<script type="text/javascript">

    RED.actions.add("flow-manager:save-flow", function() {
        $('.flow-manager-save-button').click();
    });

    let workspacesWithLocalChanges = new Set();
    let workspacesWithDeployedChanges = new Set();

    function refreshSaveFlowButtonAndTabsState() {
        const $saveButton = $('.flow-manager-save-button');
        let allowSaving = workspacesWithLocalChanges.has(RED.workspaces.active()) || workspacesWithDeployedChanges.has(RED.workspaces.active());

        if(allowSaving) {
            $saveButton.prop('disabled', false);
            $saveButton.removeClass('toolbar-button-disabled');
            $saveButton.removeClass('disabled');
        } else {
            $saveButton.prop('disabled', true);
            $saveButton.addClass('toolbar-button-disabled');
            $saveButton.addClass('disabled');
        }

        const changedWorkspacesSelectors = Array.from(new Set([...workspacesWithLocalChanges, ...workspacesWithDeployedChanges])).map(tabId=>'li#red-ui-tab-'+tabId.replace('.','-'));
        $('li.red-ui-tab').removeClass('red-ui-tab-save-flow-indicator');
        $(changedWorkspacesSelectors.join(',')).addClass('red-ui-tab-save-flow-indicator');
    }
    (function() {
        let workspacesWithLocalChangesPrevStep = new Set();

        function onWorkspaceChange(e) {
            // Startup only (listen once)
            RED.events.off('workspace:change', onWorkspaceChange);

            fetch(`flow-manager/deployed-changes`)
                .then(function(response) {
                    return response.json();
                })
                .then(function (theJsonArray) {
                    workspacesWithDeployedChanges = new Set(theJsonArray);
                    refreshSaveFlowButtonAndTabsState();
                });
        }
        RED.events.on('workspace:change', onWorkspaceChange);
        RED.comms.subscribe('flow-manager/deployed-changes', function (topic, obj) {
            workspacesWithDeployedChanges = new Set(obj);
            refreshSaveFlowButtonAndTabsState();
        });

        RED.events.on('deploy', function() {
            fetch(`flow-manager/deployed-changes`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json; charset=utf-8",
                },
                body: JSON.stringify(Array.from(workspacesWithLocalChangesPrevStep))
            })
                .then(function(response) {
                    return response.json();
                })
                .then(function(json) {
                    workspacesWithLocalChanges = new Set();
                    workspacesWithDeployedChanges = new Set(json);
                    refreshSaveFlowButtonAndTabsState();
                })
        });

        RED.events.on('nodes:change', function(e){
            let allowSaving = e.dirty;
            workspacesWithLocalChangesPrevStep = JSON.parse(JSON.stringify(Array.from(workspacesWithLocalChanges)));
            if(allowSaving) {
                workspacesWithLocalChanges.add(RED.workspaces.active());
            } else {
                workspacesWithLocalChanges.delete(RED.workspaces.active());
            }
            refreshSaveFlowButtonAndTabsState();
        });

        RED.events.on('workspace:change', function(e){
            refreshSaveFlowButtonAndTabsState();
        });
    })();

    function manageFlow(op, nodesArray) {
        let url = `flow-manager/${op}`;
        url += `/${RED.workspaces.active()}`;

        return fetch(url, {
            method: "POST",
            headers: {
                "Content-Type": "application/json; charset=utf-8",
            },
            body: JSON.stringify(nodesArray)
        })
            .then(function(response) {
                return response.json();
            })
            .then(function (theJson) {
                if(theJson.error) throw theJson.error;
                workspacesWithLocalChanges.delete(RED.workspaces.active());
                const myNotification = RED.notify("Saved successfully.", {
                    timeout: 1500,
                    buttons: [
                        {
                            text: "cool, dismiss.",
                            click: function(e) {
                                myNotification.close();
                            }
                        }
                    ]
                });
            })
            .catch(function(error) {
                const myNotification = RED.notify("Failed: " + error, {
                    type: 'warning',
                    buttons: [
                        {
                            text: "damn, dismiss.",
                            click: function(e) {
                                myNotification.close();
                            }
                        }
                    ]
                });
            });
    }

    function exportConfigNodes() {
        const configNodes = [];
        const duplicatesToDelete = [];
        RED.nodes.eachConfig(e=>{configNodes.push(e)});
        const exportableConfigNodes = RED.nodes.createExportableNodeSet(configNodes, [], duplicatesToDelete);

        // Delete flow config nodes, they are saved in their flow file.
        for(let i = exportableConfigNodes.length-1; i>=0; i--) {
            const node = exportableConfigNodes[i];
            if(node.z && node.z.length) {
                exportableConfigNodes.splice(i,1);
            }
        }

        // DeDuplicate (Might have to do it better, for now it seems to work)
        for(const idToDelete of Object.keys(duplicatesToDelete)) {
            for(let i=Object.keys(exportableConfigNodes).length-1;i>=0;i--) {
                if(exportableConfigNodes[i].id === idToDelete) {
                    exportableConfigNodes.splice(i,1);
                    break;
                }
            }
        }

        return exportableConfigNodes;
    }

    function saveCurrentFlow() {
        try {
            const activeWorkspace = RED.workspaces.active();
            const parentNode = RED.nodes.workspace(activeWorkspace)||RED.nodes.subflow(activeWorkspace);

            let allNodesInFlow = RED.nodes.filterNodes({z:activeWorkspace});
            allNodesInFlow.unshift(parentNode);
            allNodesInFlow = RED.nodes.createExportableNodeSet(allNodesInFlow);

            // Remove unrelated nodes
            const idxsToRemove = [];
            allNodesInFlow.forEach((nodeJson, index)=>{
                if(nodeJson.type !== parentNode.type) {
                    if(nodeJson.z !== activeWorkspace) {
                        idxsToRemove.unshift(index);
                    }
                } else if(nodeJson.type === 'subflow' && nodeJson.id !== parentNode.id) { // they are both equal to subflow
                    idxsToRemove.unshift(index);
                }
            });
            idxsToRemove.forEach(i=>allNodesInFlow.splice(i,1));

            const allConfigNodeIds = [];
            RED.nodes.eachConfig(c=>allConfigNodeIds.push(c.id));

            manageFlow('save', {
                flow: allNodesInFlow,
                configNodes: exportConfigNodes(),
                allConfigNodeIds: allConfigNodeIds
            }).then(e=>{
                refreshSaveFlowButtonAndTabsState();
                const oldNodeRedButton = $('#btn-deploy'); // 0.20 or less
                if(oldNodeRedButton.length) {
                    oldNodeRedButton.click();
                } else {
                    // node-red 1
                    $('.red-ui-deploy-button-content').click()
                }
            });
        } catch(e) {
            alert('No active workspace (flow/subflow)');
        }
    }

    const _nr1Header = $('ul.red-ui-header-toolbar');
    if(_nr1Header.length) {
        _nr1Header.prepend(`
        <li>
            <button onclick="saveCurrentFlow()" class="button-group red-ui-deploy-button toolbar-button toolbar-button-disabled flow-manager-save-button" href="#">
                <i class="fa fa-code-fork"></i> Save Flow
            </button>
        </li>

        <li>
            <button class="button-group red-ui-deploy-button toolbar-button flow-manager-filter-flows-button" href="#">
                <i class="fa fa-filter"></i> Filter Flows</button>
            </button>
        </li>
        `);
    } else {
        // Add "save flow" button
        $('.header-toolbar').prepend(`
        <span>
            <span>
                <button class="toolbar-button toolbar-button-disabled flow-manager-save-button" onclick="saveCurrentFlow()"><i class="fa fa-code-fork"></i> Save Flow</button>
            </span>
        </span>
        `);

        // Add "filter flows" button
        $('.header-toolbar').prepend(`
        <span>
            <span>
                <button class="toolbar-button flow-manager-filter-flows-button"><i class="fa fa-filter"></i> Filter Flows</button>
            </span>
        </span>
        `);
    }



    $('body').prepend(`
    <div>
        <dialog id="flow-manager-flows-dialog">
          <form method="dialog">
            <p><label>Show Flows:
              <div id="flow-manager-flows-dialog-options"></div>
            </label></p>
            <menu>
              <button>Cancel</button>
              <button onclick="flowManagerDialogConfirmed(this)">Confirm</button>
            </menu>
          </form>
        </dialog>
    </div>`);

    function flowManagerDialogConfirmed(target) {
        const selectAllIsChecked = $('#flow-manager-show-flow-select-all').prop('checked');

        let flowsToShow = []; // Empty array means "all"
        if(!selectAllIsChecked) {
            $('.flow-manager-show-flow-select-item').each((index,checkboxElement)=>{
                const flowName = checkboxElement.name;
                const flowEnabled = checkboxElement.checked;
                if(flowEnabled) flowsToShow.push(flowName);
            });
        }

        $.ajax({
            url: 'flow-manager/flow_visibility.json',
            contentType: "application/json",
            dataType:'json',
            data: JSON.stringify(flowsToShow),
            type: 'PUT',
            error: function(error) {
                alert(`Failed to filter algos ${error}`);
            },
            success: function () {
                location.reload();
            }
        });
    }

    function flowManagerOnSelectAllChanged(target) {
        const allChecked = target.checked;
        $('.flow-manager-show-flow-select-item').prop('disabled', allChecked?'disabled':null);
    }

    $(()=>{
        function getJsonPromise(url) {
            return new Promise( function(resolve, reject) {
                $.getJSON(url).done(resolve).error(reject);
            });
        }

        var filterFlowsButton = document.getElementsByClassName('flow-manager-filter-flows-button')[0];
        var selectFlowsDialog = document.getElementById('flow-manager-flows-dialog');

        filterFlowsButton.addEventListener('click', function() {
            Promise.all([
                getJsonPromise('flow-manager/flows.json'),
                getJsonPromise('flow-manager/flow_visibility.json').catch(e=>Promise.resolve([]))
            ]).then(([flowsArray, flowsToShow])=>{
                const $selectEl = $('#flow-manager-flows-dialog-options');
                $selectEl.empty();

                const space = '5pt';
                flowsArray = flowsArray.map(flowName=>flowName.substring(0, flowName.lastIndexOf('.')))
                flowsArray.forEach(flowName=>{
                    const thisFlowIsSelected = flowsToShow.indexOf(flowName) !== -1;
                    const optionId = `flow-manager-show-flow-${flowName}`;
                    $selectEl.append(`
                        <div style="display: flex; flex-direction: row">
                            <input class="flow-manager-show-flow-select-item" type="checkbox" id="${optionId}" name="${flowName}" value="${flowName}" ${thisFlowIsSelected?'checked="true"':''} />
                            <label for="${optionId}" style="margin-left: ${space}">${flowName}</label>
                        </div>
                    `);
                });

                $selectEl.prepend(`<div style="display: flex; flex-direction: row">
                        <input onchange="flowManagerOnSelectAllChanged(this)" type="checkbox" id="flow-manager-show-flow-select-all" name="all" value="all" />
                        <label for="flow-manager-show-flow-select-all" style="margin-left: ${space}">Show All</label>
                    </div>
                    <hr style="margin: 2pt 0;"/>`);

                const allAreSelected = flowsToShow.length === 0;
                const $selectAllElement = $('#flow-manager-show-flow-select-all');
                $selectAllElement.prop('checked', allAreSelected);
                $selectAllElement.trigger('change');

                if(selectFlowsDialog.open) return;
                selectFlowsDialog.showModal();
            }).catch(alert);
        });
    })
</script>
