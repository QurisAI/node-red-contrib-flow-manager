<style>
    .toolbar-button {
        border: none;
        color: #eee;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        margin: auto 0 auto 12pt;
        padding: 3.5pt;
    }

    .toolbar-button.toolbar-button-disabled {
        color: #999 !important;
        background-color: #444 !important;
        cursor: default !important;
    }

    .flow-manager-filter-flows-button {
        background-color: #176670 !important;;
    }

    #flow-manager-flows-dialog-options .ui-selecting {
        background: #feca40;
    }
    #flow-manager-flows-dialog-options .ui-selected {
        background: #7c9cec;
    }

    #flow-manager-flows-dialog-options { list-style-type: none; margin: 0; padding: 0; width: 60%; }
    #flow-manager-flows-dialog-options li { margin: 1px; padding: 0.2em; font-size: 1.0em;}

</style>

<script type="text/javascript">
    $(()=>{
        const _nr1Header = $('ul.red-ui-header-toolbar');
        if(_nr1Header.length) {
            _nr1Header.prepend(`
            <li>
                <button class="button-group red-ui-deploy-button toolbar-button flow-manager-filter-flows-button" href="#">
                    <i class="fa fa-filter"></i> Filter Flows</button>
                </button>
            </li>
        `);
        } else {
            // Add "filter flows" button
            $('.header-toolbar').prepend(`
            <span>
                <span>
                    <button class="toolbar-button flow-manager-filter-flows-button"><i class="fa fa-filter"></i> Filter Flows</button>
                </span>
            </span>
        `);
        }

        $('body').prepend(`
        <div>
            <dialog id="flow-manager-flows-dialog">
              <form method="dialog" style="text-align: center">
                <p><label>Load Flows:
                    <div>
                        <input id="filter-flows-all-flows-input" type="checkbox" name="all" value="all" />
                        <label for="filter-flows-all-flows-input">Load All</label>
                    </div>
                    <hr style="margin: 2pt 0;"/>
                    <ol id="flow-manager-flows-dialog-options" style="width: 100%;"></ol>
                </label></p>
                <menu>
                  <button id="filter-flows-confirm">Confirm</button>
                </menu>
              </form>
            </dialog>
        </div>`);


        RED.comms.subscribe('flow-manager/flow-manager-envnodes-override-attempt', function (topic, envNodePropsChangedByUser) {

            let text = '<br/><br/><p>'
            // Revert properties on view (those defined by envnodes)
            for(const nodeId of Object.keys(envNodePropsChangedByUser)) {
                const node = RED.nodes.node(nodeId);
                const envNodeCfg = envNodePropsChangedByUser[nodeId];

                text += '<hr/>';
                text += `<div><span style="color:#7e7d2c">${node.name || node.label || 'Unnamed'} (${nodeId})</span></div>`;
                text += `<ul>`;
                for(const envNodeCfgKey of Object.keys(envNodeCfg)) {
                    text += `<li><strong>${envNodeCfgKey}</strong>: attempt=<span style="color: #962d2d">${node[envNodeCfgKey]}</span> original=<span style="color: #55a23a">${envNodeCfg[envNodeCfgKey]}</span></li>`
                    node[envNodeCfgKey] = envNodeCfg[envNodeCfgKey];
                }
                text += `</ul>`;
                RED.editor.updateNodeProperties(node);
                RED.view.redraw();
            }

            text += '<hr/>';
            text += `</p>`;

            const myNotification = RED.notify(
                `Warning!<br/>Detected user attempt to change envnodes controlled properties.<br/>Don't worry, these properties were restored to envnodes values.${text}`, {
                    type: "warn",
                    timeout: 30000,
                    buttons: [
                        {
                            text: "Thanks",
                            click: function(e) {
                                myNotification.close();
                            }
                        }
                    ]
                });
        });


        let flowsToLoad = []; // Empty array means "all"
        $('#filter-flows-confirm').click(function flowManagerDialogConfirmed() {
            const selectAllIsChecked = $('#filter-flows-all-flows-input').prop('checked');

            $.ajax({
                url: 'flow-manager/filter-flows',
                contentType: "application/json",
                dataType:'json',
                data: JSON.stringify(selectAllIsChecked? [] : flowsToLoad),
                type: 'PUT',
                error: function(error) {
                    alert(`Failed to filter algos ${error}`);
                },
                success: function () {
                    location.reload();
                }
            });
        });

        $('#filter-flows-all-flows-input').change(function flowManagerOnSelectAllChanged(target) {
            const allChecked = target.currentTarget.checked;
            $('.flow-manager-load-flow-select-item').css('display', allChecked?'none':'');
        });

        function getJsonPromise(url) {
            return new Promise( function(resolve, reject) {
                $.getJSON(url).done(resolve).error(reject);
            });
        }

        var filterFlowsButton = document.getElementsByClassName('flow-manager-filter-flows-button')[0];
        var selectFlowsDialog = document.getElementById('flow-manager-flows-dialog');

        filterFlowsButton.addEventListener('click', function() {
            Promise.all([
                getJsonPromise('flow-manager/flow-names'),
                getJsonPromise('flow-manager/filter-flows').catch(e=>Promise.resolve([]))
            ]).then(([flowsArray, flowsFromConfig])=>{

                flowsToLoad = flowsFromConfig;

                const $selectEl = $('#flow-manager-flows-dialog-options');
                $selectEl.empty();

                $selectEl.selectable({
                    stop: function() {
                        flowsToLoad = [];
                        $( ".ui-selected", this ).each(function() {
                            const flowName = this.innerText;
                            flowsToLoad.push(flowName);
                        });
                    }
                });

                flowsArray = flowsArray.map(flowName=>flowName.substring(0, flowName.lastIndexOf('.')))
                flowsArray.forEach(flowName=>{
                    const thisFlowIsSelected = flowsFromConfig.indexOf(flowName) !== -1;
                    $selectEl.append(`
                        <li class="flow-manager-load-flow-select-item ui-widget-content ${thisFlowIsSelected?'ui-selected':''}">
                            ${flowName}
                        </li>
                    `);
                });

                $( selectFlowsDialog ).dialog();
                $('#filter-flows-all-flows-input').prop('checked', !flowsFromConfig || !flowsFromConfig.length )
                $('#filter-flows-all-flows-input').trigger('change')
            }).catch(alert);
        });
    })
</script>
